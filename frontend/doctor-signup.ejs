<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/doctor sign-up.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">     
</head>
<body class="page">
    <div class="card" role="main">  
        <div class="logo">
            <img class="logo-img" src="resources\logo\logo.png">     
            <span class="logo-text"><span style="color: rgb(0, 0, 0);">Ø¯Ú©ØªØ± </span>Ø±Ø²Ø±Ùˆ </span>     
        </div>
        <h1>Ø«Ø¨Øª Ù†Ø§Ù…</h1>  
        <p class="form-subtitle"><span style="color: rgb(0, 0, 0);font-size: 20px;font-weight: 500;">Ù…Ø±Ø­Ù„Ù‡ Û± </span>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p> 
        <form autocomplete="on" novalidate action="/signup/doctor" method="post"> 
            <div class="form-row">
                <div class="form-group"> 
                    <label for="first">Ù†Ø§Ù…</label>
                    <input id="first" name="first" type="text" placeholder="ÙØ§Ø·Ù…Ù‡" aria-label="Ù†Ø§Ù…" />  
                </div>  
                <div class="form-group">  
                    <label for="last">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>  
                    <input id="last" name="last" type="text" placeholder="Ù…Ø­Ù…Ø¯ÛŒ" aria-label="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />  
                </div>
            </div>   
            <div class="form-row"> 
                <div class="form-group">  
                    <label for="birth_display">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label>
                    <div class="date-wrap">
                        <input id="birth_display" name="birthday" type="text" placeholder="Û±Û´Û°Û°/Û°Û±/Û°Û±" inputmode="numeric" />
                        <input id="birth" name="birth" type="hidden" /> 
                        <button type="button" id="birth_toggle" class="date-toggle" aria-haspopup="dialog" aria-expanded="false">ğŸ“…</button>
                    </div>
                    <div id="birth_cal" class="calendar" role="dialog" aria-modal="false" aria-label="ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ" hidden>
                        <div class="cal-header">
                            <div class="cal-title" id="cal_title">ÙØ±ÙˆØ±Ø¯ÛŒÙ† Û±Û´Û°Û°</div>
                            <div class="cal-controls">
                                <button type="button" id="cal_prev" aria-label="Ù…Ø§Ù‡ Ù‚Ø¨Ù„">â€¹</button>
                                <button type="button" id="cal_next" aria-label="Ù…Ø§Ù‡ Ø¨Ø¹Ø¯">â€º</button>
                            </div>
                        </div>
                        <div class="weekdays" aria-hidden="true">
                            <div>Ø´</div><div>ÛŒ</div><div>Ø¯</div><div>Ø³</div><div>Ú†</div><div>Ù¾</div><div>Ø¬</div>
                        </div>
                        <div class="days" id="cal_days" role="grid"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="nid">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                    <input id="nid" name="natinolCode" type="text" placeholder="137xxxx" aria-label="Ú©Ø¯ Ù…Ù„ÛŒ" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="province">Ø§Ø³ØªØ§Ù†</label>
                    <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
                        <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <option>ØªÙ‡Ø±Ø§Ù†</option>
                        <option>Ø§Ù„Ø¨Ø±Ø²</option>
                        <option>Ø§ØµÙÙ‡Ø§Ù†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¬Ù†Ø³ÛŒØª</label>
                    <div class="gender-group" role="radiogroup" aria-label="Ø¬Ù†Ø³ÛŒØª">
                        <label class="radio-option">
                            <input type="radio" name="gender" value="FEMALE" checked aria-checked="true">
                            <span class="radio-control" aria-hidden="true"></span>
                            <span class="radio-label">Ø®Ø§Ù†Ù…</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="gender" value="MALe" aria-checked="false">
                            <span class="radio-control" aria-hidden="true"></span>
                            <span class="radio-label">Ø¢Ù‚Ø§</span>
                        </label>
                    </div> 
                </div>  
            </div>
            <div class="form-row">
                <div class="form-group">  
                    <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
                    <input id="email" name="email" type="email" placeholder="example@mail.com" aria-label="Ø§ÛŒÙ…ÛŒÙ„" />  
                </div> 
                <div class="form-group">
                    <label for="city">Ø´Ù‡Ø±</label>
                    <input id="city" name="city" type="text" placeholder="ØªÙ‡Ø±Ø§Ù†" aria-label="Ø´Ù‡Ø±" />
                </div> 
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
                    <input id="phone" name="phone" type="tel" placeholder="09xxxxxxxxx" aria-label="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" />
                </div> 
            </div>  
            <hr>   
            <p class="form-subtitle"><span style="color: rgb(0, 0, 0);font-size: 20px;font-weight: 500;">Ù…Ø±Ø­Ù„Ù‡ Û² </span>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø±ÙÙ‡ Ø§ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>       
            <div class="form-row">
                <div class="form-group">
                    <label for="province">Ø¯Ø±Ø¬Ù‡ Ø¹Ù„Ù…ÛŒ</label>
                    <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
                        <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <option>Ù¾Ø²Ø´Ú© Ø¹Ù…ÙˆÙ…ÛŒ</option>
                        <option>Ù…ØªØ®ØµØµ</option> 
                        <option>ÙÙˆÙ‚ ØªØ®ØµØµ</option>
                        <option>ÙÙ„ÙˆØ´ÛŒÙ¾</option>
                    </select> 
                </div>         
                <div class="form-group">
                    <label for="province">ØªØ®ØµØµ</label>
                    <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
                        <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <%spti.forEach(option=>{%>
                          <option value="<%=option.spetialty%>"><%=option.spetialty%></option>
                        <%})%>
                    </select>
                </div>
            </div>       
            <div class="form-row">
                <div class="form-group">
                    <label for="medical_code">Ú©Ø¯ Ù†Ø¸Ø§Ù… Ù¾Ø²Ø´Ú©ÛŒ</label>
                    <input id="medical_code" name="medical_code" type="text" />
                </div>
                <div class="form-group">
                    <label>Ù…Ø¯Ø±Ú© Ù†Ø¸Ø§Ù… Ù¾Ø²Ø´Ú©ÛŒ</label>
                    <button type="button" class="upload-btn" id="uploadBtn">
                        Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
                    </button>
                    <input
                    type="file"
                    id="medicalFile"
                    accept="image/*,.pdf"
                    hidden
                    />
                </div>
            </div>
            <hr> 
            <p class="form-subtitle"><span style="color: rgb(0, 0, 0);font-size: 20px;font-weight: 500;">Ù…Ø±Ø­Ù„Ù‡ Û³ </span>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø­Ù„ ÙØ¹Ø§Ù„ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>      
            <div class="form-row">
                <div class="form-group">
                    <label for="province">Ø§Ø³ØªØ§Ù†</label>
                    <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
                        <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <option>ØªÙ‡Ø±Ø§Ù†</option>
                        <option>Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ</option>
                        <option>Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ</option>
                        <option>Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ</option>
                    </select>
                </div>        
                <div class="form-group">
                    <label for="province">Ø´Ù‡Ø±</label>
                    <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
                        <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <option>ØªÙ‡Ø±Ø§Ù†</option>
                        <option>ØªØ¨Ø±ÛŒØ²</option>
                        <option>Ø§Ø±ÙˆÙ…ÛŒÙ‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="address">Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„</label>
                    <textarea id="address" name="address" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®ÛŒØ§Ø¨Ø§Ù† ÙˆÙ„ÛŒØ¹ØµØ±ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³" aria-label="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="first">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù…Ø·Ø¨</label>       
                    <input id="first" name="first" type="text" placeholder="" aria-label="Ù†Ø§Ù…" />    
                </div>     
            </div>      
            <div class="signin-link">
                Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="/login_signUp">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø²Ø´Ú© </a>
            </div>
            <!-- <div class="signin-link">
                <a href="#" style="font-size: 17px; font-weight: 400;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø²Ø´Ú©</a>
            </div> -->
            <div class="actions">
                <button type="submit" class="btn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
        </form>
    </div>
<script>
  const uploadBtn = document.getElementById('uploadBtn');
  const medicalFile = document.getElementById('medicalFile');

  uploadBtn.addEventListener('click', () => {
    medicalFile.click();
  });

  medicalFile.addEventListener('change', () => {
    if (medicalFile.files.length > 0) {
      uploadBtn.textContent = 'ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯';
      uploadBtn.classList.add('uploaded');
    } else {
      uploadBtn.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„';
      uploadBtn.classList.remove('uploaded');
    }
  });
</script>


  <script>
    function div(a,b){ return Math.floor(a/b); }

    function toJalaali(gy,gm,gd){
      var g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
      gy -= 1600; gm -= 1; gd -= 1;
      var g_day_no = 365*gy + div(gy+3,4) - div(gy+99,100) + div(gy+399,400);
      g_day_no += g_d_m[gm] + gd;
      if (gm > 1 && (( (gy+1600)%4==0 && ( (gy+1600)%100!=0 || ( (gy+1600)%400==0) )))) g_day_no++;
      var j_day_no = g_day_no - 79;
      var j_np = div(j_day_no, 12053);
      j_day_no = j_day_no % 12053;
      var jy = 979 + 33*j_np + 4*div(j_day_no,1461);
      j_day_no %= 1461;
      if (j_day_no >= 366){
        jy += div(j_day_no-366,365);
        j_day_no = (j_day_no-366) % 365;
      }
      var jm, jd;
      var jalali_month_days = [31,31,31,31,31,31,30,30,30,30,30,29];
      for (var i=0;i<11;i++){
        if (j_day_no < jalali_month_days[i]) { jm = i+1; jd = j_day_no+1; break; }
        j_day_no -= jalali_month_days[i];
      }
      if (jm === undefined) { jm = 12; jd = j_day_no+1; }
      return {jy: jy, jm: jm, jd: jd};
    }

    function toGregorian(jy,jm,jd){
      jy -= 979; jm -= 1; jd -= 1;
      var j_day_no = 365*jy + div(jy,33)*8 + div((jy%33)+3,4);
      var i;
      var jalali_month_days = [31,31,31,31,31,31,30,30,30,30,30,29];
      for (i=0;i<jm;i++) j_day_no += jalali_month_days[i];
      j_day_no += jd;
      var g_day_no = j_day_no + 79;
      var gy = 1600 + 400*div(g_day_no,146097);
      g_day_no = g_day_no % 146097;
      var leap = true;
      if (g_day_no >= 36525){
        g_day_no--;
        gy += 100*div(g_day_no,36524);
        g_day_no = g_day_no % 36524;
        if (g_day_no >= 365) g_day_no++;
        else leap = false;
      }
      gy += 4*div(g_day_no,1461);
      g_day_no %= 1461;
      if (g_day_no >= 366){
        gy += div(g_day_no-366,365);
        g_day_no = (g_day_no-366) % 365;
      }
      var gd_m = [0,31,28,31,30,31,30,31,31,30,31,30,31];
      if ((gy%4==0 && gy%100!=0) || (gy%400==0)) gd_m[2]=29; else gd_m[2]=28;
      var gm=0, gd=0;
      for (i=1;i<=12;i++){
        var v = gd_m[i];
        if (g_day_no < v){ gm = i; gd = g_day_no+1; break; }
        g_day_no -= v;
      }
      return {gy:gy,gm:gm,gd:gd};
    }

    /* ==== Utility: Persian numerals and month names ==== */
    const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
    function toPersianNumber(n){
      return String(n).split('').map(c => (/\d/.test(c) ? persianDigits[+c] : c)).join('');
    }

    const persianMonthNames = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±","Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"];

    /* ==== Calendar rendering and interaction ==== */
    (function(){
      // elements
      const display = document.getElementById('birth_display');
      const hidden = document.getElementById('birth');
      const toggle = document.getElementById('birth_toggle');
      const cal = document.getElementById('birth_cal');
      const title = document.getElementById('cal_title');
      const daysContainer = document.getElementById('cal_days');
      const prevBtn = document.getElementById('cal_prev');
      const nextBtn = document.getElementById('cal_next');

      // start with today
      const today = new Date();
      const todayJ = toJalaali(today.getFullYear(), today.getMonth()+1, today.getDate());
      let viewYear = todayJ.jy;
      let viewMonth = todayJ.jm;

      // helper: pad
      function pad(n){ return n<10 ? '0'+n : String(n); }

      // render calendar for viewMonth/viewYear (Jalali)
      function renderCalendar(){
        title.textContent = persianMonthNames[viewMonth-1] + ' ' + toPersianNumber(viewYear);
        daysContainer.innerHTML = '';

        // compute first day of this jalali month in gregorian to know weekday
        // approach: get gregorian for (viewYear, viewMonth, 1) then create Date and read weekday
        const g = toGregorian(viewYear, viewMonth, 1);
        const firstWeekday = new Date(g.gy, g.gm - 1, g.gd).getDay(); // 0 Sun .. 6 Sat (note: JS Sun=0)
        // We want week starting Saturday(Ø´Ù†Ø¨Ù‡). Let's map JS weekday to index where Saturday=0:
        // JS: Sun=0, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
        // desired index: Sat(6)->0, Sun(0)->1, Mon(1)->2, ..., Fri(5)->6
        const startIndex = (firstWeekday + 1) % 7; // maps JS day to our Saturday-based index

        // number of days in this jalali month
        const mdays = [31,31,31,31,31,31,30,30,30,30,30,29];
        // check leap for last month (Esfand) -> if leap year then 30
        // Jalali leap calculation: using conversion toGregorian and back is ok; simpler: check toGregorian(viewYear,12,29) and see month/day
        let daysInMonth = mdays[viewMonth-1];
        if (viewMonth === 12){
          // if 29th Esfand corresponds to next gregorian? simpler: check if toGregorian(viewYear,12,30) is valid -> but our conversion always returns a valid date.
          // Safer: compute gregorian of (viewYear,12,30) and then back to jalali; if back equals (viewYear,12,30) then leap (i.e., 30th exists)
          const gtest = toGregorian(viewYear,12,30);
          const jback = toJalaali(gtest.gy, gtest.gm, gtest.gd);
          if (jback.jy === viewYear && jback.jm === 12 && jback.jd === 30) daysInMonth = 30;
        }

        // fill blanks before first day (startIndex)
        for (let i=0;i<startIndex;i++){
          const el = document.createElement('div'); el.className = 'day other-month'; el.setAttribute('aria-hidden','true'); el.textContent = ''; daysContainer.appendChild(el);
        }

        // add day cells
        for (let d=1; d<=daysInMonth; d++){
          const el = document.createElement('div');
          el.className = 'day';
          el.setAttribute('role','button');
          el.tabIndex = 0;
          el.dataset.jy = viewYear; el.dataset.jm = viewMonth; el.dataset.jd = d;
          el.textContent = toPersianNumber(d);
          // mark today?
          if (viewYear === todayJ.jy && viewMonth === todayJ.jm && d === todayJ.jd){
            el.classList.add('today');
          }
          // mark selected if matches hidden value
          if (hidden.value){
            const [gy,gm,gd] = hidden.value.split('-').map(Number);
            const selectedJ = toJalaali(gy,gm,gd);
            if (selectedJ.jy === viewYear && selectedJ.jm === viewMonth && selectedJ.jd === d){
              el.classList.add('selected');
            }
          }
          // click handler
          el.addEventListener('click', () => {
            selectDate(viewYear, viewMonth, d);
            closeCal();
            toggle.focus();
          });
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' '){
              e.preventDefault(); el.click();
            }
          });
          daysContainer.appendChild(el);
        }

        // ensure keyboard focusability
      }

      function selectDate(jy,jm,jd){
        // set visible as Persian formatted
        display.value = toPersianNumber(jy) + '/' + toPersianNumber(jm.toString().padStart(2,'0')) + '/' + toPersianNumber(jd.toString().padStart(2,'0'));
        // set hidden ISO gregorian yyyy-mm-dd
        const g = toGregorian(jy,jm,jd);
        hidden.value = g.gy + '-' + pad(g.gm) + '-' + pad(g.gd);
        // visually mark selected
        const prev = daysContainer.querySelector('.day.selected');
        if (prev) prev.classList.remove('selected');
        const sel = Array.from(daysContainer.children).find(node => node.dataset.jd == jd && node.dataset.jm == jm && node.dataset.jy == jy);
        if (sel) sel.classList.add('selected');
      }

      function openCal(){
        cal.hidden = false;
        toggle.setAttribute('aria-expanded','true');
        renderCalendar();
      }
      function closeCal(){
        cal.hidden = true;
        toggle.setAttribute('aria-expanded','false');
      }

      // init: if hidden has value (maybe prefilled), populate display
      if (hidden.value){
        const [gy,gm,gd] = hidden.value.split('-').map(Number);
        const j = toJalaali(gy,gm,gd);
        display.value = toPersianNumber(j.jy) + '/' + toPersianNumber(String(j.jm).padStart(2,'0')) + '/' + toPersianNumber(String(j.jd).padStart(2,'0'));
      } else {
        // optionally prefill with empty or a placeholder; leave empty
      }

      // toggle handlers
      toggle.addEventListener('click', () => {
        if (cal.hidden) openCal(); else closeCal();
      });

      // navigate months
      prevBtn.addEventListener('click', () => {
        viewMonth--;
        if (viewMonth < 1){ viewMonth = 12; viewYear--; }
        renderCalendar();
      });
      nextBtn.addEventListener('click', () => {
        viewMonth++;
        if (viewMonth > 12){ viewMonth = 1; viewYear++; }
        renderCalendar();
      });

      // close on outside click
      document.addEventListener('click', (e) => {
        if (!cal.contains(e.target) && !toggle.contains(e.target) && e.target !== display){
          closeCal();
        }
      });

      // keyboard: open with Enter/Space when focus on display or toggle
      [display, toggle].forEach(el => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            if (cal.hidden) openCal(); else closeCal();
          } else if (e.key === 'ArrowDown'){
            openCal();
            // focus first day
            setTimeout(()=> {
              const firstDay = daysContainer.querySelector('.day:not(.other-month)');
              if (firstDay) firstDay.focus();
            },50);
          }
        });
      });

      // initialize view to today or to selected date if present
      if (hidden.value){
        const [gy,gm,gd] = hidden.value.split('-').map(Number);
        const j = toJalaali(gy,gm,gd);
        viewYear = j.jy; viewMonth = j.jm;
      } else {
        viewYear = todayJ.jy; viewMonth = todayJ.jm;
      }
      renderCalendar();

      // expose for testing if needed
      window._jalaliCalendar = { selectDate, renderCalendar };
    })();

    // ---------- typing support ----------
function normalizeDigits(str){
  const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
  const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
  return str.replace(/[Û°-Û¹]/g, d => fa.indexOf(d))
            .replace(/[Ù -Ù©]/g, d => ar.indexOf(d));
}

function isValidJalali(jy, jm, jd){
  if (jm < 1 || jm > 12 || jd < 1) return false;
  const mdays = [31,31,31,31,31,31,30,30,30,30,30,29];
  let max = mdays[jm-1];

  // leap year check for Esfand
  if (jm === 12){
    const g = toGregorian(jy,12,30);
    const j = toJalaali(g.gy,g.gm,g.gd);
    if (j.jd === 30) max = 30;
  }
  return jd <= max;
}

display.addEventListener('input', () => {
  let val = normalizeDigits(display.value).replace(/[^0-9/]/g,'');

  // auto format YYYY/MM/DD
  if (val.length === 4 || val.length === 7) val += '/';
  display.value = val;

  const m = val.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if (!m) return;

  const jy = +m[1], jm = +m[2], jd = +m[3];
  if (!isValidJalali(jy,jm,jd)) return;

  const g = toGregorian(jy,jm,jd);
  hidden.value = `${g.gy}-${pad(g.gm)}-${pad(g.gd)}`;

  viewYear = jy;
  viewMonth = jm;
  renderCalendar();
});

display.addEventListener('blur', () => {
  // Ø§Ú¯Ø± Ù†Ø§Ù‚Øµ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯ Ù¾Ø§Ú© Ú©Ù†
  const v = normalizeDigits(display.value);
  if (!/^(\d{4})\/(\d{2})\/(\d{2})$/.test(v)){
    display.value = '';
    hidden.value = '';
  }
});

  </script>
</body>
</html>
