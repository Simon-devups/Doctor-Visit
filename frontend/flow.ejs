<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/flow.css">
    <script>
        // Load more comments functionality
        function loadMoreComments() {
            const commentContainer = document.querySelector('.N2-comments');
            const showMoreBtn = document.querySelector('.show-more-comments');
            
            // Validate elements exist
            if (!commentContainer || !showMoreBtn) {
                console.warn('Comment elements not found');
                return;
            }

            // Create and insert new comments
            newComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.setAttribute('role', 'article');
                commentDiv.setAttribute('aria-label', `نظر از ${comment.name}`);
                
                commentDiv.innerHTML = `
                    <div class="comment-top">
                        <div class="comment-date">${comment.date}</div>
                        <div class="comment-property">
                            <div class="comment-starsAndname">
                                <div class="name">${comment.name}</div>
                                <div class="stars" aria-label="رتبه‌بندی"></div>
                            </div>
                            <div class="comment-profile">
                                <img src="${comment.avatar}" alt="پروفایل ${comment.name}" loading="lazy">
                            </div>
                        </div>
                    </div>
                    <p class="comment-nazar">${comment.text}</p>
                `;
                
                commentContainer.insertBefore(commentDiv, showMoreBtn);
            });

            // Hide the "show more" button after loading
            showMoreBtn.style.display = 'none';
            showMoreBtn.setAttribute('aria-hidden', 'true');
        }

        // Bio expand/collapse functionality
        document.addEventListener('DOMContentLoaded', function () {
            const flowTop = document.querySelector('.flow-top');
            if (!flowTop) return;

            const btn = flowTop.querySelector('.expand-btn');
            const collapse = flowTop.querySelector('.bio-collapse');

            // Defensive checks
            if (!btn || !collapse) return;

            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const isOpen = flowTop.classList.toggle('open');
                
                // Update ARIA attributes for accessibility
                btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                collapse.setAttribute('aria-hidden', isOpen ? 'false' : 'true');

                // Smooth scroll on mobile to show revealed content
                if (isOpen && window.innerWidth <= 650) {
                    setTimeout(() => {
                        collapse.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 150);
                }
            });
        });
    </script>

</head>

<body>

    <%- include('partials/header1') %>

    <div class="breadcrumb-section">
        <span class="breadcrumb-title">صفحه پزشک</span>
        <img src="/recourses/vectors/right-icon-circle.svg" alt="آیکن">
    </div>
    <main class="main">
        <div class="left-m">
            <!-- persian-calendar.html -->
            <section class="pc-card" dir="rtl" aria-label="تقویم فارسی">
                <header class="pc-header">
                    <h3 class="pc-title">تقویم</h3>
                    <div class="pc-top-row">
                        <button class="pc-nav pc-prev" aria-label="ماه قبل">‹</button>
                        <div class="pc-month">دی ۱۴۰۳</div>
                        <button class="pc-nav pc-next" aria-label="ماه بعد">›</button>
                    </div>
                    <div class="pc-small-date">۱۵ دی ماه ۱۴۰۳</div>
                </header>

                <div class="pc-weekdays" aria-hidden="true">
                    <div>شنبه</div>
                    <div>یکشنبه</div>
                    <div>دوشنبه</div>
                    <div>سه‌شنبه</div>
                    <div>چهارشنبه</div>
                    <div>پنج‌شنبه</div>
                    <div>جمعه</div>
                </div>

                <!-- Day grid: static demo for دی ۱۴۰۳.
        JS will need to generate days dynamically later. -->
                <div class="pc-grid" role="grid" aria-label="روزهای ماه">
                    <!-- each .pc-day has data-day for future JS -->
                    <div class="pc-day empty" aria-hidden="true"></div>
                    <div class="pc-day empty" aria-hidden="true"></div>
                    <div class="pc-day">۱</div>
                    <div class="pc-day">۲</div>
                    <div class="pc-day">۳</div>
                    <div class="pc-day">۴</div>
                    <div class="pc-day">۵</div>

                    <div class="pc-day">۶</div>
                    <div class="pc-day">۷</div>
                    <div class="pc-day">۸</div>
                    <div class="pc-day">۹</div>
                    <div class="pc-day">۱۰</div>
                    <div class="pc-day">۱۱</div>
                    <div class="pc-day">۱۲</div>

                    <div class="pc-day">۱۳</div>
                    <div class="pc-day">۱۴</div>
                    <div class="pc-day pc-today" aria-current="date">۱۵</div>
                    <div class="pc-day">۱۶</div>
                    <div class="pc-day">۱۷</div>
                    <div class="pc-day">۱۸</div>
                    <div class="pc-day">۱۹</div>

                    <div class="pc-day">۲۰</div>
                    <div class="pc-day">۲۱</div>
                    <div class="pc-day">۲۲</div>
                    <div class="pc-day">۲۳</div>
                    <div class="pc-day">۲۴</div>
                    <div class="pc-day">۲۵</div>
                    <div class="pc-day">۲۶</div>

                    <div class="pc-day">۲۷</div>
                    <div class="pc-day">۲۸</div>
                    <div class="pc-day">۲۹</div>
                    <div class="pc-day">۳۰</div>
                    <div class="pc-day empty muted">۱</div> <!-- overflow next month (example) -->
                    <div class="pc-day empty muted">۲</div>
                    <div class="pc-day empty muted">۳</div>
                </div>

                <!-- Time slots area (visual only). JS can toggle .active -->
                <div class="pc-times">
                    <div class="pc-times-row">
                        <button class="pc-slot outlined" aria-pressed="false">۱۰:۰۰</button>
                        <button class="pc-slot outlined" aria-pressed="false">۱۰:۱۵</button>
                        <button class="pc-slot outlined" aria-pressed="false">۱۰:۳۰</button>
                    </div>
                </div>

                <div class="pc-actions">
                    <a class="pc-reserve" >رزرو نوبت</a>
                </div>
            </section>

        </div>
        <div class="right-m">
            <div class="flow-top">
                <div class="doctor-bio">
                    <div class="doctor-code">
                        <span class="doctor-code-text">
                            <span><span class="code-label">کد نظام پزشکی: </span><span class="code-value"><%=doctor.description[0].code%></span></span>
                            <img style="height: 1.4rem; " src="/recourses/vectors/CheckCircle.svg" alt="تایید">
                        </span>
                    </div>
                    <div class="left-lables">
                        <div class="title"><%=doctor.first_name%> <%=doctor.last_name%></div>
                        <div class="doctor-specialty"><%=doctor.spetialty.spetialty%></div>
                        <div class="doctor-comments-count">(<span class="n-of-comments"></span> نظر)</div>
                    </div>
                    <div class="flow-img"><img src="/images/<%=doctor.image_url%>" alt="تصویر دکتر زهرا وارسته" loading="lazy"></div>
                </div>
                <div class="clinic-address">
                    <%=doctor.description[0].Addres%>
                    <img src="/recourses/vectors/map-pinpoint-02.svg" alt="آیکن موقعیت">
                </div>
                <div class="appointment-info">
                    <div class="appointment-day">دوشنبه ۲۴ دی</div>
                    <span class="appointment-text">: اولین نوبت در دسترس</span>
                    <img src="/recourses/vectors/alarm-clock.svg" alt="آیکن ساعت">
                </div>
                <hr style="margin-top: 0.5rem;">
                <!-- replace original about block with this -->
                <div class="about-bio">
                    <span class="title about-section-title">درباره دکتر <%=doctor.first_name%> <%=doctor.last_name%> </span>

                    <!-- collapsed wrapper (short visible area) -->
                    <div class="bio-collapse" aria-hidden="true">
                        <p class="bio-text">
                            <%=doctor.description[0].description%>
                        </p>
                    </div>

                    <!-- red circular button -->
                    <button class="expand-btn" aria-expanded="false" aria-label="نمایش بیشتر"><img src="/recourses/vectors/Vector (Stroke).svg" alt=""></button>
                </div>

            </div>
            <div class="rah-cont">
                <!-- داخل بعدا اد میشه -->
                <div class="rah-ertebati"
                    style="display: flex;flex-direction: column; margin-bottom: 1rem; margin-right: 1%;">
                    <div class="title">راه های ارتباطی</div>
                </div>
                <div class="in-cont">
                    <div class="in-rah"><%=contact.instagram%> <img src="./recourses/vectors/instagram.svg"
                            alt=""></div>
                    <div class="in-rah"> شماره تماس: <span><%=contact.phone%></span> <img src="./recourses/vectors/telephone.svg" alt="">
                    </div>
                    <div class="in-rah"><a style="color: rgb(42, 42, 42);" href="https://<%=contact.web%>"><%=contact.web%></a><img src="./recourses/vectors/chrome.svg" alt=""></div>
                </div>
            </div>

    </main>
    <div class="nazarat-cont">
        <div class="title">نظرات کاربران</div>
        <div class="N-flex">
            <div class="comment-stars">(<span class="n-of-comments"></span>) نظر</div>
            <div class="recommendation-text">
                <p>مراجعان این پزشک را پیشنهاد داده‌اند</p>
                <span><%=doctorRecommend%>%</span>
                <img src="/recourses/vectors/thumbs-up.svg" style="max-height: 1.4rem;" alt="آیکن تأیید">
            </div>
            <a href="/comment/<%=doctor.id%>" class="sabte-nazar">
                <img src="/recourses/vectors/comment add-01.svg" alt="">ثبت نظر
            </a>
        </div>

        <div class="N2-comments">
            <%comments.forEach(comment=>{%>
                
                <div class="comment">
                    <div class="comment-top">
                        <div class="comment-date" style="font-size: 0.9rem; direction: rtl;"> <%=comment.date%> </div>
                        <div class="comment-property">
                            <div class="comment-starsAndname">
                                <div class="name"><%=comment.user.firt_name%> <%=comment.user.last_name%></div>
                                <div class="stars" aria-label="رتبه‌بندی"></div>
                            </div>
                            <div class="comment-profile"><img src="/uploads/<%=comment.user.avatar_url%>" alt="پروفایل <%=comment.user.firt_name%>" loading="lazy"></div>
                        </div>
                    </div>
                    <p class="comment-nazar"><%=comment.comment%></p>
                </div>
            <%})%>
            
            <div class="show-more-comments" onclick="loadMoreComments()" role="button" tabindex="0" aria-label="نمایش نظرات بیشتر">
                <img src="/recourses/vectors/Down.svg" alt="">نظرات بیشتر
            </div>
        </div>
    </div>
    
    <%- include('partials/footer') %>

<script src="/js/jalaali.js"></script>
<script>
/* === اگر توابع جلالی را در یک فایل جدا داری، آن را اینجا import یا include کن.
   برای مثال اگر داخل <script src="/js/jalaali.js">
 است، آن را قبل از این script بارگذاری کن. */

/* Persian month names */
const PERSIAN_MONTHS = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];

/* small helper to convert persian digits to english numbers if needed */
function persianToEnglishDigits(str){
  const map = {'۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
  return String(str).replace(/[۰-۹]/g, d => map[d]);
}

// Convert ASCII digits (or numbers) to Persian numerals
function toPersianNumber(input){
    const map = {'0':'۰','1':'۱','2':'۲','3':'۳','4':'۴','5':'۵','6':'۶','7':'۷','8':'۸','9':'۹'};
    return String(input).replace(/\d/g, d => map[d]);
}

/* --- Utility: generate array grid for a jalaali month --- */
function generateCalendarArray(jy, jm){ // jm: 1..12
  // convert 1st day of jalaali month -> gregorian
  const g = jalaaliToGregorian(jy, jm, 1); // object {gy, gm, gd}
  const firstDate = new Date(g.gy, g.gm - 1, g.gd);
  // Shift so 0 = شنبه
  let firstDayIndex = (firstDate.getDay() + 1) % 7;
  const daysInMonth = getJalaaliMonthDays(jy, jm);

  const arr = [];
  for(let i=0;i<firstDayIndex;i++) arr.push(null);
  for(let d=1; d<=daysInMonth; d++) arr.push(d);
  // pad to fill full weeks (optional)
  while(arr.length % 7 !== 0) arr.push(null);
  return arr;
}

/* --- Render calendar into DOM --- */
function renderCalendar(jy, jm){
  const monthLabel = document.querySelector('.pc-month');
  const smallDate = document.querySelector('.pc-small-date');
  const grid = document.querySelector('.pc-grid');

  // set month label: "دی ۱۴۰۳"
  monthLabel.textContent = `${PERSIAN_MONTHS[jm-1]} ${toPersianNumber(jy)}`;

  // smallDate = today's jalaali full if same month (we'll set later)
  grid.innerHTML = ''; // clear

  const cal = generateCalendarArray(jy, jm);
  cal.forEach(cell => {
    const div = document.createElement('div');
    div.classList.add('pc-day');
    if(cell === null){
      div.classList.add('empty');
      div.setAttribute('aria-hidden','true');
      div.textContent = '';
    } else {
      div.textContent = toPersianNumber(cell);
      div.dataset.day = String(cell);
      div.tabIndex = 0;
      // add click
      div.addEventListener('click', onDayClick);
    }
    grid.appendChild(div);
  });

  // mark today if this month contains today
  const todayG = new Date(); // now
  const todayJ = gregorianToJalaali(todayG.getFullYear(), todayG.getMonth()+1, todayG.getDate());
  if(todayJ.jy === jy && todayJ.jm === jm){
    // find element with dataset day === todayJ.jd
    const els = grid.querySelectorAll('.pc-day');
    els.forEach(el=>{
      if(el.dataset.day && Number(el.dataset.day) === todayJ.jd){
        el.classList.add('pc-today');
        smallDate.textContent = `${toPersianNumber(todayJ.jd)} ${PERSIAN_MONTHS[todayJ.jm-1]} ${toPersianNumber(todayJ.jy)}`;
      }
    });
  } else {
    smallDate.textContent = `${toPersianNumber(1)} ${PERSIAN_MONTHS[jm-1]} ${toPersianNumber(jy)}`;
  }
}

/* --- when user clicks a day --- */
let selectedDateGregorian = null;
async function onDayClick(e){
  const day = Number(e.currentTarget.dataset.day);
  if(!day) return;

  // get month/year from label
  const monthText = document.querySelector('.pc-month').textContent.trim(); // e.g. "دی ۱۴۰۳"
  const parts = monthText.split(' ');
  const jmName = parts[0];
  const jy = Number(persianToEnglishDigits(parts[1]));
  const jm = PERSIAN_MONTHS.indexOf(jmName) + 1;

  // convert jalaali -> gregorian
  const g = jalaaliToGregorian(jy, jm, day);
  selectedDateGregorian = `${g.gy}-${String(g.gm).padStart(2,'0')}-${String(g.gd).padStart(2,'0')}`;

  // UI: mark selected
  document.querySelectorAll('.pc-day').forEach(d => d.classList.remove('pc-today'));
  e.currentTarget.classList.add('pc-today');

  // fetch availability for this date
  try {
    const doctorId = "<%=doctor.id%>"; // ensure server template replaces it
    const res = await fetch(`/calender/${doctorId}/checkDay?date=${selectedDateGregorian}`);
    if(!res.ok) throw new Error('fetch failed');
    const json = await res.json();
    renderTimeSlots(json.data || []);
  } catch(err){
    console.error('خطا در دریافت تایم‌ها', err);
  }
}

/* --- render times --- */
function renderTimeSlots(times){
  const row = document.querySelector('.pc-times-row');
  row.innerHTML = '';
  if(!times || times.length === 0){
    row.innerHTML = '<div class="no-slots">تایمی موجود نیست</div>';
    return;
  }
  times.forEach(t=>{
    const btn = document.createElement('button');
    btn.className = 'pc-slot outlined';
    btn.textContent = toPersianNumber(t.start);
    if(!t.isAvailable) btn.disabled = true;
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.pc-slot').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // store selected time if needed
      window.selectedTime = t.start;
    });
    btn.dataset.time = t.start;
    row.appendChild(btn);
  });
}

/* --- prev / next month buttons --- */
let currentJy, currentJm;
document.addEventListener('DOMContentLoaded', function(){
  // compute current Jalaali month
  const now = new Date();
  const nowJ = gregorianToJalaali(now.getFullYear(), now.getMonth()+1, now.getDate());
  currentJy = nowJ.jy;
  currentJm = nowJ.jm;

  renderCalendar(currentJy, currentJm);

  // prev/next
  document.querySelector('.pc-prev').addEventListener('click', ()=>{
    currentJm--;
    if(currentJm < 1){ currentJm = 12; currentJy--; }
    renderCalendar(currentJy, currentJm);
  });
  document.querySelector('.pc-next').addEventListener('click', ()=>{
    currentJm++;
    if(currentJm > 12){ currentJm = 1; currentJy++; }
    renderCalendar(currentJy, currentJm);
  });

  // optionally auto-fetch availability for today
  const todayG = now;
  const todayGStr = `${todayG.getFullYear()}-${String(todayG.getMonth()+1).padStart(2,'0')}-${String(todayG.getDate()).padStart(2,'0')}`;
  // convert to jalaali and simulate click:
  const dayEl = Array.from(document.querySelectorAll('.pc-day')).find(el => el.dataset.day && Number(el.dataset.day) === nowJ.jd);
  if(dayEl) dayEl.click();
});

// number of comments to persian digits
const nOfComments = document.querySelectorAll('.n-of-comments');
document.addEventListener("DOMContentLoaded", function() {
        nOfComments.forEach(div => {
        div.textContent = toPersianNumber('<%=comments.length%>');
    });
})
</script>
<script>
    //فانکشن یو آی
    function createToaster(message){      
        const Message = document.createElement('div');
        Message.className='error-handler-cont';
        Message.style.position='fixed';
        Message.style.bottom='2rem';
        Message.style.right='2rem';
            Message.innerText=message;
        document.body.appendChild(Message)
        setTimeout(() => {
            Message.classList.add('add');
        }, 50);
        setTimeout(() => {
            Message.classList.add('less')
        }, 3000);
        setTimeout(() => {
            Message.remove();
        }, 3700);
    }

    const ahrefBtn = document.querySelector('.pc-reserve');
    
    // Store selected date and time
    let selectedDate = null;
    let selectedTime = null;

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.pc-slot');
        if (!btn || btn.disabled) return;

        document.querySelectorAll('.pc-slot')
            .forEach(b => b.classList.remove('active'));

        btn.classList.add('active');

        selectedTime = btn.dataset.time;
        console.log('Selected time:', selectedTime);

        updateReserveLink();
    });

    // Remove default href since we'll add it dynamically
    
    // Listen for time slot selections (dynamically created buttons)
    ahrefBtn.addEventListener('click', function (e) {
        console.log(selectedTime)
        if (!selectedDateGregorian || !selectedTime) {
            e.preventDefault();
            createToaster('لطفاً ابتدا روز و ساعت را انتخاب کنید');
            return;
        }

        ahrefBtn.href =
            `/reserveDoctor/<%=doctor.id%>?date=${encodeURIComponent(
                selectedDateGregorian
            )}&time=${encodeURIComponent(selectedTime)}`;

        ahrefBtn.style.cursor = 'pointer';
    });



    // document.addEventListener('click', function(e) {
    //     if(e.target.closest('.pc-times-row .pc-slot')) {
    //         const btn = e.target.closest('.pc-times-row .pc-slot');
    //         if(btn.disabled) return;
            
    //         // Update all time slots - remove active from others
    //         document.querySelectorAll('.pc-times-row .pc-slot').forEach(b => {
    //             b.classList.remove('active');
    //         });
    //         btn.classList.add('active');
            
    //         // Store selected time
    //         selectedTime = btn.dataset.time;            
    //         console.log('Selected time:', selectedTime);
            
    //         if (selectedDateGregorian && selectedTime) {
    //             // اضافه کردن پارامترهای کوئری به href
    //             ahrefBtn.href = `/reserveDoctor/${encodeURIComponent(doctor.id)}?date=${encodeURIComponent(selectedDateGregorian)}&time=${encodeURIComponent(selectedTime)}`;
    //             ahrefBtn.style.cursor = 'pointer';
    //         }
    //     }
    // });
    
    // Hook into the existing onDayClick to track selected date
    const originalOnDayClick = window.onDayClick;
    window.onDayClick = function(e) {
        originalOnDayClick.call(this, e);
        selectedDate = e.currentTarget.dataset.day;
        console.log('Selected date:', selectedDate, 'Gregorian:', selectedDateGregorian);
        selectedTime = null; // Reset time when date changes
        ahrefBtn.href = ''; // Clear href until time is selected
    };

 
    //راستی آزمایی لاگین برای ثبت نظر
    document.querySelector('.sabte-nazar').addEventListener('click' , async (e)=>{
        e.preventDefault();
        try{
            const response = await fetch('/check-login');
            const result = await response.json();
            function createToaster(message){
                const Message = document.createElement('div');
                Message.className='error-handler-cont';
                Message.style.position='fixed';
                Message.style.bottom='2rem';
                Message.style.right='2rem';
                 Message.innerText=message;
                document.body.appendChild(Message)
                setTimeout(() => {
                    Message.classList.add('add');
                }, 50);
                setTimeout(() => {
                    Message.classList.add('less')
                }, 3000);
                setTimeout(() => {
                    Message.remove();
                }, 3700);}

            if(response.ok && result.authenticated){
                window.location.href = "/comment/<%=doctor.id%>";
            }
            else {
                createToaster(result.message);
            }
        }
        catch(err){
            console.log(err,'بررسی لاگین ناموفق')
        }
    });

</script>



</body>

</html>