<!doctype html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  <title>ÙØ±Ù… Ø«Ø¨Øª Ù†Ø§Ù… â€” Ø¯Ú©ØªØ± Ø±Ø²Ø±Ùˆ</title>
  <style>
    :root {
      --bg-1: #f8fafc;
      --bg-2: #f0f5fb;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-soft: #64748b;
      --text-lighter: #94a3b8;
      --accent: #2563eb;
      --accent-strong: #1e40af;
      --accent-light: #eff6ff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-lg: 0 10px 40px rgba(15, 23, 42, .08);
      --shadow-md: 0 4px 16px rgba(15, 23, 42, .05);
      --shadow-sm: 0 2px 8px rgba(15, 23, 42, .03);
      font-family: "Vazirmatn", "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      background: linear-gradient(to bottom, var(--bg-1), var(--bg-2));
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-main);
      direction: rtl;
      font-family: 'vazirmatn';
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .card {
      width: 100%;
      max-width: 920px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 40px 48px;
      position: relative;
      border: 1px solid var(--border-light);
      overflow: hidden;
      scale: 0.8;
    }

    /* header */
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      font-weight: 800;
      color: var(--accent-strong);
      font-size: 16px;
    }

    .brand .cross {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 20px;
      box-shadow: 0 6px 20px rgba(37, 99, 235, .25);

    }

    h1 {
      margin: 0 0 6px;
      font-size: 26px;
      font-weight: 800;
      color: var(--text-main);
      letter-spacing: -.4px;
    }

    .form-subtitle {
      color: var(--text-soft);
      font-size: 15px;
      margin-bottom: 20px;
      font-weight: 400;
      line-height: 1.5;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* grid rows: use minmax(0,1fr) to avoid content-driven shrinking */
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      align-items: start;
    }

    .form-row.full {
      grid-template-columns: 1fr;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
      /* critical to stop column from shrinking in grid */
    }

    label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: .3px;
    }

    input,
    select,
    button {
      font-family: inherit;
    }

    input,
    select {
      width: 100%;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 400;
      color: var(--text-main);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--border-light);
      transition: .18s ease;
      min-width: 0;
    }

    input::placeholder {
      color: var(--text-lighter)
    }

    input:hover {
      border-color: var(--accent);
      background: #fff;
    }

    input:focus,
    select:focus {
      outline: none;
      background: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-light);
    }

    /* select: RTL friendly icon + padding-right */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2'%3e%3cpath d='M6 9l6 6 6-6'%3e%3c/path%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      /* RTL: icon on right */
      background-size: 18px;
      padding-right: 40px;
      /* leave space for the icon */
    }

    /* gender custom radios: accessible + consistent */
    .gender-group {
      display: flex;
      gap: 24px;
      align-items: center;
      padding: 8px 0;
      flex-wrap: wrap;
    }

    .radio-option {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      transition: .2s ease;
    }

    .radio-option:hover .radio-label {
      color: var(--accent);
    }

    .radio-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: auto;
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
    }

    .radio-control {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 20px;
      box-sizing: border-box;
      transition: all .2s cubic-bezier(.34, .1, .64, .1);
      background: #fff;
      position: relative;
    }

    .radio-control::after {
      content: "";
      display: block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      transform: scale(0);
      transition: transform .2s cubic-bezier(.34, .1, .64, .1);
      box-shadow: 0 0 8px rgba(37, 99, 235, .4);
    }

    .radio-option input[type="radio"]:hover+.radio-control {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
      background: #fff;
    }

    .radio-option input[type="radio"]:checked+.radio-control {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .radio-option input[type="radio"]:checked+.radio-control::after {
      transform: scale(1);
    }

    .radio-option input[type="radio"]:focus+.radio-control {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-light);
    }

    .radio-option .radio-label {
      font-weight: 500;
      color: var(--text-main);
    }

    /* actions */
    .actions {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: .18s ease;
      letter-spacing: .3px;
      font-family: 'vazirmatn';
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(37, 99, 235, .22)
    }

    .btn:active {
      transform: translateY(0)
    }

    .signin-link {
      text-align: center;
      font-size: 14px;
      color: var(--text-soft);
    }

    .signin-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700
    }

    /* responsive */
    @media (max-width:900px) {
      .card {
        padding: 36px 40px
      }
    }

    @media (max-width:768px) {

      html,
      body {
        padding: 16px
      }

      .card {
        padding: 32px;
        border-radius: 12px
      }

      h1 {
        font-size: 24px
      }

      .form-subtitle {
        font-size: 14px;
        margin-bottom: 24px
      }

      .form-row {
        gap: 16px
      }

      label {
        font-size: 14px
      }

      input,
      select {
        font-size: 14px;
        padding: 11px 13px
      }

      .gender-group {
        gap: 18px
      }
    }

    @media (max-width:580px) {

      html,
      body {
        padding: 22px;
        display: unset;
      }

      .card {
        padding: 24px;
        border-radius: 10px
      }

      h1 {
        font-size: 22px;
        margin-bottom: 4px
      }

      .form-subtitle {
        font-size: 13px;
        margin-bottom: 20px
      }

      form {
        gap: 18px
      }

      .form-row {
        gap: 14px
      }

      .form-row,
      .form-row.full {
        grid-template-columns: 1fr
      }

      label {
        font-size: 13px
      }

      input,
      select {
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 8px
      }

      .gender-group {
        gap: 16px;
        padding: 4px 0
      }

      .radio-option {
        gap: 8px
      }

      .radio-control {
        width: 18px;
        height: 18px;
        border-width: 1.5px
      }

      .radio-control::after {
        width: 6px;
        height: 6px
      }

      .radio-label {
        font-size: 13px
      }

      .actions {
        margin-top: 4px;
        gap: 8px
      }

      .btn {
        padding: 12px;
        font-size: 14px
      }

      .signin-link {
        font-size: 13px
      }

      .card {
        scale: unset;
      }
    }

    @media (max-width:380px) {

      html,
      body {
        padding: 10px
      }

      .card {
        padding: 18px;
        border-radius: 8px
      }

      .brand {
        gap: 8px;
        margin-bottom: 16px
      }

      .brand .cross {
        width: 40px;
        height: 40px;
        font-size: 18px
      }

      h1 {
        font-size: 20px
      }

      .form-subtitle {
        font-size: 12px;
        margin-bottom: 16px
      }

      form {
        gap: 16px
      }

      label {
        font-size: 12px
      }

      input,
      select {
        font-size: 12px;
        padding: 9px 10px
      }

      .gender-group {
        gap: 12px
      }

      .btn {
        padding: 10px;
        font-size: 13px
      }
    }

    #province {
      border-radius: 10px;
    }

    #province option {
      color: #2563eb;
      border-radius: 10px;
    }

    select {
      color: var(--text-soft);
    }

    /* --- Persian date-picker styles --- */
    .date-wrap {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .date-wrap input[readonly] {
      cursor: pointer;
      background: #fff
    }

    .date-toggle {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--border-light), #fff);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    .calendar {
      margin-top: 8px;
      width: 320px;
      max-width: 100%;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      padding: 12px;
      direction: rtl;
    }

    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px
    }

    .cal-title {
      font-weight: 700
    }

    .cal-controls button {
      background: none;
      border: 0;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      color: var(--text-lighter);
      font-size: 13px;
      padding: 6px 0
    }

    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px
    }

    .day {
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px;
    }

    .day:hover {
      background: var(--accent-light);
      color: var(--accent);
      font-weight: 700
    }

    .day.other-month {
      opacity: .28
    }

    .day.selected {
      background: var(--accent);
      color: #fff;
      font-weight: 800;
      box-shadow: 0 6px 20px rgba(37, 99, 235, .18)
    }

    .day.today {
      box-shadow: inset 0 0 0 2px var(--accent-light)
    }

    /* responsive small */
    @media (max-width:420px) {
      .calendar {
        width: 100%
      }

      .day {
        min-height: 32px;
        font-size: 14px
      }
    }
  </style>
</head>

<body class="page">
  <div class="card" role="main">
    <div class="brand" aria-hidden="true">
      <div class="cross">+</div>
      <div style="font-size:18px; color: #2563eb;">Ø¯Ú©ØªØ± Ø±Ø²Ø±Ùˆ</div>
    </div>

    <h1>Ø«Ø¨Øª Ù†Ø§Ù…</h1>
    <p class="form-subtitle">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯</p>

    <form autocomplete="on" novalidate method="post" action="/signUp" enctype="multipart/form-data">

      <div class="form-row">
        <div class="form-group">
          <label for="first">Ù†Ø§Ù…</label>
          <input id="first" name="first_name" type="text" placeholder="ÙØ§Ø·Ù…Ù‡" aria-label="Ù†Ø§Ù…" />
        </div>
        <div class="form-group">
          <label for="last">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
          <input id="last" name="last_name" type="text" placeholder="Ù…Ø­Ù…Ø¯ÛŒ" aria-label="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />
        </div>
      </div>

      <div class="form-row">
        <!-- === Persian Date Picker (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† input[type=date]) === -->
        <div class="form-group">
          <label for="birth_display">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label>
          <div class="date-wrap">
            <!-- visible Jalali display -->
            <input id="birth_display" name="birthday" type="text" placeholder="Û±Û´Û°Û°/Û°Û±/Û°Û±" inputmode="numeric" />
            <!-- hidden ISO (gregorian) value for server -->
            <input id="birth" name="birth" type="hidden" />
            <button type="button" id="birth_toggle" class="date-toggle" aria-haspopup="dialog"
              aria-expanded="false">ğŸ“…</button>
          </div>

          <!-- calendar popup -->
          <div id="birth_cal" class="calendar" role="dialog" aria-modal="false" aria-label="ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ" hidden>
            <div class="cal-header">
              <div class="cal-title" id="cal_title">ÙØ±ÙˆØ±Ø¯ÛŒÙ† Û±Û´Û°Û°</div>
              <div class="cal-controls">
                <button type="button" id="cal_prev" aria-label="Ù…Ø§Ù‡ Ù‚Ø¨Ù„">â€¹</button>
                <button type="button" id="cal_next" aria-label="Ù…Ø§Ù‡ Ø¨Ø¹Ø¯">â€º</button>
              </div>
            </div>
            <div class="weekdays" aria-hidden="true">
              <!-- Ø´Ù†Ø¨Ù‡ .. Ø¬Ù…Ø¹Ù‡ -->
              <div>Ø´</div>
              <div>ÛŒ</div>
              <div>Ø¯</div>
              <div>Ø³</div>
              <div>Ú†</div>
              <div>Ù¾</div>
              <div>Ø¬</div>
            </div>
            <div class="days" id="cal_days" role="grid"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="nid">Ú©Ø¯ Ù…Ù„ÛŒ</label>
          <input id="nid" name="code_meli" type="text" placeholder="137xxxx" aria-label="Ú©Ø¯ Ù…Ù„ÛŒ" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="province">Ø§Ø³ØªØ§Ù†</label>
          <select id="province" name="province" aria-label="Ø§Ø³ØªØ§Ù†">
            <option value="" style="color:#64748b;" disabled selected hidden>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option>ØªÙ‡Ø±Ø§Ù†</option>
            <option>Ø§Ù„Ø¨Ø±Ø²</option>
            <option>Ø§ØµÙÙ‡Ø§Ù†</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ø¬Ù†Ø³ÛŒØª</label>
          <div class="gender-group" role="radiogroup" aria-label="Ø¬Ù†Ø³ÛŒØª">

            <label class="radio-option">
              <input type="radio" name="gender" value="FEMALE" checked aria-checked="true">
              <span class="radio-control" aria-hidden="true"></span>
              <span class="radio-label">Ø®Ø§Ù†Ù…</span>
            </label>

            <label class="radio-option">
              <input type="radio" name="gender" value="MALE" aria-checked="false">
              <span class="radio-control" aria-hidden="true"></span>
              <span class="radio-label">Ø¢Ù‚Ø§</span>
            </label>

          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
          <input id="email" name="email" type="email" placeholder="example@mail.com" aria-label="Ø§ÛŒÙ…ÛŒÙ„" />
        </div>
        <div class="form-group">
          <label for="city">Ø´Ù‡Ø±</label>
          <input id="city" name="city" type="text" placeholder="ØªÙ‡Ø±Ø§Ù†" aria-label="Ø´Ù‡Ø±" />
        </div>
      </div>

      <div class="form-row full">
        <div class="form-group">
          <label for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
          <input id="phone" name="phone" type="tel" placeholder="09xxxxxxxxx" aria-label="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" />
        </div>
      </div>
      <div class="avatar">
        <input type="file" name="avatar" accept="image/*" required>
      </div>

      <div class="signin-link">
        Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="/login_signUp">ÙˆØ±ÙˆØ¯</a>
      </div>
      <div class="signin-link">
        <a href="#" style="font-size: 17px; font-weight: 400;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø²Ø´Ú©</a>
      </div>
      <div class="actions">
        <button type="submit" class="btn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
      </div>

    </form>
  </div>

  <script>
    /* ==========================
       Jalaali / Gregorian conversion
       (based on the widely used "jalaali-js" algorithm)
       ========================== */

    function div(a, b) { return Math.floor(a / b); }

    function toJalaali(gy, gm, gd) {
      var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
      gy -= 1600; gm -= 1; gd -= 1;
      var g_day_no = 365 * gy + div(gy + 3, 4) - div(gy + 99, 100) + div(gy + 399, 400);
      g_day_no += g_d_m[gm] + gd;
      if (gm > 1 && (((gy + 1600) % 4 == 0 && ((gy + 1600) % 100 != 0 || ((gy + 1600) % 400 == 0))))) g_day_no++;
      var j_day_no = g_day_no - 79;
      var j_np = div(j_day_no, 12053);
      j_day_no = j_day_no % 12053;
      var jy = 979 + 33 * j_np + 4 * div(j_day_no, 1461);
      j_day_no %= 1461;
      if (j_day_no >= 366) {
        jy += div(j_day_no - 366, 365);
        j_day_no = (j_day_no - 366) % 365;
      }
      var jm, jd;
      var jalali_month_days = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
      for (var i = 0; i < 11; i++) {
        if (j_day_no < jalali_month_days[i]) { jm = i + 1; jd = j_day_no + 1; break; }
        j_day_no -= jalali_month_days[i];
      }
      if (jm === undefined) { jm = 12; jd = j_day_no + 1; }
      return { jy: jy, jm: jm, jd: jd };
    }

    function toGregorian(jy, jm, jd) {
      jy -= 979; jm -= 1; jd -= 1;
      var j_day_no = 365 * jy + div(jy, 33) * 8 + div((jy % 33) + 3, 4);
      var i;
      var jalali_month_days = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
      for (i = 0; i < jm; i++) j_day_no += jalali_month_days[i];
      j_day_no += jd;
      var g_day_no = j_day_no + 79;
      var gy = 1600 + 400 * div(g_day_no, 146097);
      g_day_no = g_day_no % 146097;
      var leap = true;
      if (g_day_no >= 36525) {
        g_day_no--;
        gy += 100 * div(g_day_no, 36524);
        g_day_no = g_day_no % 36524;
        if (g_day_no >= 365) g_day_no++;
        else leap = false;
      }
      gy += 4 * div(g_day_no, 1461);
      g_day_no %= 1461;
      if (g_day_no >= 366) {
        gy += div(g_day_no - 366, 365);
        g_day_no = (g_day_no - 366) % 365;
      }
      var gd_m = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      if ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0)) gd_m[2] = 29; else gd_m[2] = 28;
      var gm = 0, gd = 0;
      for (i = 1; i <= 12; i++) {
        var v = gd_m[i];
        if (g_day_no < v) { gm = i; gd = g_day_no + 1; break; }
        g_day_no -= v;
      }
      return { gy: gy, gm: gm, gd: gd };
    }

    /* ==== Utility: Persian numerals and month names ==== */
    const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
    function toPersianNumber(n) {
      return String(n).split('').map(c => (/\d/.test(c) ? persianDigits[+c] : c)).join('');
    }

    const persianMonthNames = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];

    /* ==== Calendar rendering and interaction ==== */
    (function () {
      // elements
      const display = document.getElementById('birth_display');
      const hidden = document.getElementById('birth');
      const toggle = document.getElementById('birth_toggle');
      const cal = document.getElementById('birth_cal');
      const title = document.getElementById('cal_title');
      const daysContainer = document.getElementById('cal_days');
      const prevBtn = document.getElementById('cal_prev');
      const nextBtn = document.getElementById('cal_next');

      // start with today
      const today = new Date();
      const todayJ = toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
      let viewYear = todayJ.jy;
      let viewMonth = todayJ.jm;

      // helper: pad
      function pad(n) { return n < 10 ? '0' + n : String(n); }

      // render calendar for viewMonth/viewYear (Jalali)
      function renderCalendar() {
        title.textContent = persianMonthNames[viewMonth - 1] + ' ' + toPersianNumber(viewYear);
        daysContainer.innerHTML = '';

        // compute first day of this jalali month in gregorian to know weekday
        // approach: get gregorian for (viewYear, viewMonth, 1) then create Date and read weekday
        const g = toGregorian(viewYear, viewMonth, 1);
        const firstWeekday = new Date(g.gy, g.gm - 1, g.gd).getDay(); // 0 Sun .. 6 Sat (note: JS Sun=0)
        // We want week starting Saturday(Ø´Ù†Ø¨Ù‡). Let's map JS weekday to index where Saturday=0:
        // JS: Sun=0, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
        // desired index: Sat(6)->0, Sun(0)->1, Mon(1)->2, ..., Fri(5)->6
        const startIndex = (firstWeekday + 1) % 7; // maps JS day to our Saturday-based index

        // number of days in this jalali month
        const mdays = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
        // check leap for last month (Esfand) -> if leap year then 30
        // Jalali leap calculation: using conversion toGregorian and back is ok; simpler: check toGregorian(viewYear,12,29) and see month/day
        let daysInMonth = mdays[viewMonth - 1];
        if (viewMonth === 12) {
          // if 29th Esfand corresponds to next gregorian? simpler: check if toGregorian(viewYear,12,30) is valid -> but our conversion always returns a valid date.
          // Safer: compute gregorian of (viewYear,12,30) and then back to jalali; if back equals (viewYear,12,30) then leap (i.e., 30th exists)
          const gtest = toGregorian(viewYear, 12, 30);
          const jback = toJalaali(gtest.gy, gtest.gm, gtest.gd);
          if (jback.jy === viewYear && jback.jm === 12 && jback.jd === 30) daysInMonth = 30;
        }

        // fill blanks before first day (startIndex)
        for (let i = 0; i < startIndex; i++) {
          const el = document.createElement('div'); el.className = 'day other-month'; el.setAttribute('aria-hidden', 'true'); el.textContent = ''; daysContainer.appendChild(el);
        }

        // add day cells
        for (let d = 1; d <= daysInMonth; d++) {
          const el = document.createElement('div');
          el.className = 'day';
          el.setAttribute('role', 'button');
          el.tabIndex = 0;
          el.dataset.jy = viewYear; el.dataset.jm = viewMonth; el.dataset.jd = d;
          el.textContent = toPersianNumber(d);
          // mark today?
          if (viewYear === todayJ.jy && viewMonth === todayJ.jm && d === todayJ.jd) {
            el.classList.add('today');
          }
          // mark selected if matches hidden value
          if (hidden.value) {
            const [gy, gm, gd] = hidden.value.split('-').map(Number);
            const selectedJ = toJalaali(gy, gm, gd);
            if (selectedJ.jy === viewYear && selectedJ.jm === viewMonth && selectedJ.jd === d) {
              el.classList.add('selected');
            }
          }
          // click handler
          el.addEventListener('click', () => {
            selectDate(viewYear, viewMonth, d);
            closeCal();
            toggle.focus();
          });
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault(); el.click();
            }
          });
          daysContainer.appendChild(el);
        }

        // ensure keyboard focusability
      }

      function selectDate(jy, jm, jd) {
        // set visible as Persian formatted
        display.value = toPersianNumber(jy) + '/' + toPersianNumber(jm.toString().padStart(2, '0')) + '/' + toPersianNumber(jd.toString().padStart(2, '0'));
        // set hidden ISO gregorian yyyy-mm-dd
        const g = toGregorian(jy, jm, jd);
        hidden.value = g.gy + '-' + pad(g.gm) + '-' + pad(g.gd);
        // visually mark selected
        const prev = daysContainer.querySelector('.day.selected');
        if (prev) prev.classList.remove('selected');
        const sel = Array.from(daysContainer.children).find(node => node.dataset.jd == jd && node.dataset.jm == jm && node.dataset.jy == jy);
        if (sel) sel.classList.add('selected');
      }

      function openCal() {
        cal.hidden = false;
        toggle.setAttribute('aria-expanded', 'true');
        renderCalendar();
      }
      function closeCal() {
        cal.hidden = true;
        toggle.setAttribute('aria-expanded', 'false');
      }

      // init: if hidden has value (maybe prefilled), populate display
      if (hidden.value) {
        const [gy, gm, gd] = hidden.value.split('-').map(Number);
        const j = toJalaali(gy, gm, gd);
        display.value = toPersianNumber(j.jy) + '/' + toPersianNumber(String(j.jm).padStart(2, '0')) + '/' + toPersianNumber(String(j.jd).padStart(2, '0'));
      } else {
        // optionally prefill with empty or a placeholder; leave empty
      }

      // toggle handlers
      toggle.addEventListener('click', () => {
        if (cal.hidden) openCal(); else closeCal();
      });

      // navigate months
      prevBtn.addEventListener('click', () => {
        viewMonth--;
        if (viewMonth < 1) { viewMonth = 12; viewYear--; }
        renderCalendar();
      });
      nextBtn.addEventListener('click', () => {
        viewMonth++;
        if (viewMonth > 12) { viewMonth = 1; viewYear++; }
        renderCalendar();
      });

      // close on outside click
      document.addEventListener('click', (e) => {
        if (!cal.contains(e.target) && !toggle.contains(e.target) && e.target !== display) {
          closeCal();
        }
      });

      // keyboard: open with Enter/Space when focus on display or toggle
      [display, toggle].forEach(el => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (cal.hidden) openCal(); else closeCal();
          } else if (e.key === 'ArrowDown') {
            openCal();
            // focus first day
            setTimeout(() => {
              const firstDay = daysContainer.querySelector('.day:not(.other-month)');
              if (firstDay) firstDay.focus();
            }, 50);
          }
        });
      });

      // initialize view to today or to selected date if present
      if (hidden.value) {
        const [gy, gm, gd] = hidden.value.split('-').map(Number);
        const j = toJalaali(gy, gm, gd);
        viewYear = j.jy; viewMonth = j.jm;
      } else {
        viewYear = todayJ.jy; viewMonth = todayJ.jm;
      }
      renderCalendar();

      // expose for testing if needed
      window._jalaliCalendar = { selectDate, renderCalendar };
    })();

    // ---------- typing support ----------
    function normalizeDigits(str) {
      const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      return str.replace(/[Û°-Û¹]/g, d => fa.indexOf(d))
        .replace(/[Ù -Ù©]/g, d => ar.indexOf(d));
    }

    function isValidJalali(jy, jm, jd) {
      if (jm < 1 || jm > 12 || jd < 1) return false;
      const mdays = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
      let max = mdays[jm - 1];

      // leap year check for Esfand
      if (jm === 12) {
        const g = toGregorian(jy, 12, 30);
        const j = toJalaali(g.gy, g.gm, g.gd);
        if (j.jd === 30) max = 30;
      }
      return jd <= max;
    }

    display.addEventListener('input', () => {
      let val = normalizeDigits(display.value).replace(/[^0-9/]/g, '');

      // auto format YYYY/MM/DD
      if (val.length === 4 || val.length === 7) val += '/';
      display.value = val;

      const m = val.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
      if (!m) return;

      const jy = +m[1], jm = +m[2], jd = +m[3];
      if (!isValidJalali(jy, jm, jd)) return;

      const g = toGregorian(jy, jm, jd);
      hidden.value = `${g.gy}-${pad(g.gm)}-${pad(g.gd)}`;

      viewYear = jy;
      viewMonth = jm;
      renderCalendar();
    });

    display.addEventListener('blur', () => {
      // Ø§Ú¯Ø± Ù†Ø§Ù‚Øµ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯ Ù¾Ø§Ú© Ú©Ù†
      const v = normalizeDigits(display.value);
      if (!/^(\d{4})\/(\d{2})\/(\d{2})$/.test(v)) {
        display.value = '';
        hidden.value = '';
      }
    });

  </script>
</body>

</html>